package com.resources.axml;

import java.io.IOException;
import java.nio.ByteBuffer;
import java.nio.ByteOrder;
import java.nio.IntBuffer;
import java.util.logging.Logger;

import static com.resources.axml.NodeVisitor.TYPE_INT_BOOLEAN;
import static com.resources.axml.NodeVisitor.TYPE_STRING;

/**
 * AxmlParser - Android AXMLËß£ÊûêÂô®
 *
 * @author Manifest Builder Team
 */
public class AxmlParser implements ResConst {
    private static final Logger LOGGER = Logger.getLogger(AxmlParser.class.getName());

    public static final int END_FILE = 7;
    public static final int END_NS = 5;
    public static final int END_TAG = 3;
    public static final int START_FILE = 1;
    public static final int START_NS = 4;
    public static final int START_TAG = 2;
    public static final int TEXT = 6;

    private int attributeCount;

    private IntBuffer attrs;

    private int classAttribute;
    private int fileSize = -1;
    private int idAttribute;
    private ByteBuffer in;
    private int lineNumber;
    private int nameIdx;
    private int nsIdx;

    private int prefixIdx;

    private int[] resourceIds;

    private String[] strings;

    private int styleAttribute;

    private int textIdx;
    
    // ‰øùÂ≠òStringPoolÁöÑflagsÔºàUTF-8/UTF-16ÁºñÁ†ÅÊ†áÂøóÔºâ
    private int stringPoolFlags = 0;
    
    // ÂÅ•Â£ÆÊÄßÊ†áÂøó
    private boolean hasEncounteredStartElement = false;

    public AxmlParser(byte[] data) {
        this(ByteBuffer.wrap(data));
    }

    public AxmlParser(ByteBuffer in) {
        super();
        this.in = in.order(ByteOrder.LITTLE_ENDIAN);
    }

    public int getAttrCount() {
        return attributeCount;
    }

    public int getAttributeCount() {
        return attributeCount;
    }

    public String getAttrName(int i) {
        int idx = attrs.get(i * 5 + 1);
        return strings[idx];
    }

    public String getAttrNs(int i) {
        int idx = attrs.get(i * 5 + 0);
        return idx >= 0 ? strings[idx] : null;
    }

    String getAttrRawString(int i) {
        int idx = attrs.get(i * 5 + 2);
        if (idx >= 0) {
            return strings[idx];
        }
        return null;
    }

    public int getAttrResId(int i) {
        if (resourceIds != null) {
            int idx = attrs.get(i * 5 + 1);
            if (idx >= 0 && idx < resourceIds.length) {
                return resourceIds[idx];
            }
        }
        return -1;
    }

    public int getAttrType(int i) {
        return attrs.get(i * 5 + 3) >> 24;
    }

    /**
     * Ëé∑ÂèñÂ±ûÊÄßÂÄº
     * ÊîØÊåÅ9Áßç‰∏ªË¶ÅÂ±ûÊÄßÁ±ªÂûã
     * 
     * @param i Â±ûÊÄßÁ¥¢Âºï
     * @return Â±ûÊÄßÂÄºÂØπË±°
     */
    public Object getAttrValue(int i) {
        int v = attrs.get(i * 5 + 4);

        // Â§ÑÁêÜÁâπÊÆäÂ±ûÊÄßÔºàid, style, classÔºâ
        if (i == idAttribute) {
            return ValueWrapper.wrapId(v, getAttrRawString(i));
        } else if (i == styleAttribute) {
            return ValueWrapper.wrapStyle(v, getAttrRawString(i));
        } else if (i == classAttribute) {
            return ValueWrapper.wrapClass(v, getAttrRawString(i));
        }

        int type = getAttrType(i);
        String rawString = getAttrRawString(i);

        switch (type) {
        // 1. TYPE_NULL (0x00) - Á©∫ÂÄº
        case com.resources.util.TypedValue.TYPE_NULL:
            if (v == com.resources.util.TypedValue.DATA_NULL_EMPTY) {
                return null;  // @empty
            }
            return null;  // @null or undefined
            
        // 2. TYPE_REFERENCE (0x01) - ËµÑÊ∫êÂºïÁî®
        case com.resources.util.TypedValue.TYPE_REFERENCE:
            return new ResourceReference(v, rawString);
            
        // 3. TYPE_ATTRIBUTE (0x02) - Â±ûÊÄßÂºïÁî® (Â¶Ç android:attr/textColor)
        case com.resources.util.TypedValue.TYPE_ATTRIBUTE:
            return new ResourceReference(v, rawString);
            
        // 4. TYPE_STRING (0x03) - Â≠óÁ¨¶‰∏≤
        case TYPE_STRING:
            if (v >= 0 && v < strings.length) {
                return strings[v];
            }
            LOGGER.warning(String.format("Invalid string index %d (pool size=%d)", v, strings.length));
            return rawString != null ? rawString : "";
            
        // 5. TYPE_FLOAT (0x04) - ÊµÆÁÇπÊï∞
        case com.resources.util.TypedValue.TYPE_FLOAT:
            return Float.intBitsToFloat(v);
            
        // 6. TYPE_DIMENSION (0x05) - Â∞∫ÂØ∏ÂÄº (Â¶Ç 16dp, 24sp)
        case com.resources.util.TypedValue.TYPE_DIMENSION:
            // ËøîÂõûÂ§çÊùÇÊï∞ÊçÆÔºåË∞ÉÁî®ËÄÖÂèØÈÄöËøáTypedValue.complexToFloat()ÂíågetComplexUnit()Ëß£Êûê
            return v;  // Â§çÊùÇÊï∞ÊçÆÔºå‰øùÊåÅÂéüÂßãÂÄº
            
        // 7. TYPE_FRACTION (0x06) - ÁôæÂàÜÊØî (Â¶Ç 50%, 75%p)
        case com.resources.util.TypedValue.TYPE_FRACTION:
            // ËøîÂõûÂ§çÊùÇÊï∞ÊçÆÔºåË∞ÉÁî®ËÄÖÂèØÈÄöËøáTypedValue.complexToFraction()Ëß£Êûê
            return v;  // Â§çÊùÇÊï∞ÊçÆÔºå‰øùÊåÅÂéüÂßãÂÄº
            
        // 8. TYPE_DYNAMIC_REFERENCE (0x07) - Âä®ÊÄÅËµÑÊ∫êÂºïÁî®
        case com.resources.util.TypedValue.TYPE_DYNAMIC_REFERENCE:
            return new ResourceReference(v, rawString);
            
        // 9. TYPE_DYNAMIC_ATTRIBUTE (0x08) - Âä®ÊÄÅÂ±ûÊÄßÂºïÁî®
        case com.resources.util.TypedValue.TYPE_DYNAMIC_ATTRIBUTE:
            return new ResourceReference(v, rawString);
            
        // 10. TYPE_INT_BOOLEAN (0x12) - Â∏ÉÂ∞îÂÄº
        case TYPE_INT_BOOLEAN:
            return v != 0;
            
        // 11. ÂÖ∂‰ªñÊï¥ÂûãÂÄº (0x10-0x1F)
        case com.resources.util.TypedValue.TYPE_INT_DEC:
        case com.resources.util.TypedValue.TYPE_INT_HEX:
        case com.resources.util.TypedValue.TYPE_INT_COLOR_ARGB8:
        case com.resources.util.TypedValue.TYPE_INT_COLOR_RGB8:
        case com.resources.util.TypedValue.TYPE_INT_COLOR_ARGB4:
        case com.resources.util.TypedValue.TYPE_INT_COLOR_RGB4:
            return v;
            
        default:
            // Êú™Áü•Á±ªÂûãÔºåËøîÂõûÂéüÂßãÂÄºÂπ∂ËÆ∞ÂΩïË≠¶Âëä
            if (type >= com.resources.util.TypedValue.TYPE_FIRST_INT 
                && type <= com.resources.util.TypedValue.TYPE_LAST_INT) {
                return v;  // Êï¥ÂûãËåÉÂõ¥ÂÜÖÁöÑÂÖ∂‰ªñÁ±ªÂûã
            }
            LOGGER.warning(String.format("Unknown attribute type: 0x%02x, returning raw value", type));
            return v;
        }
    }

    public int getLineNumber() {
        return lineNumber;
    }

    public String getName() {
        return strings[nameIdx];
    }

    public String getNamespacePrefix() {
        return strings[prefixIdx];
    }

    public String getNamespaceUri() {
        return nsIdx >= 0 ? strings[nsIdx] : null;
    }

    public String getText() {
        return strings[textIdx];
    }

    public int next() throws IOException {
        if (fileSize < 0) {
            int type = in.getInt() & 0xFFFF;
            if (type != RES_XML_TYPE) {
                throw new RuntimeException("Invalid AXML file type: expected " + RES_XML_TYPE + ", got " + type);
            }
            fileSize = in.getInt();
            return START_FILE;
        }
        int event = -1;
        for (int p = in.position(); p < fileSize; p = in.position()) {
            // Èò≤Âæ°#2070: ÂºÇÂ∏∏ÁöÑÊñá‰ª∂ÁªìÂ∞æÔºàÂèÇËÄÉ Apktool BinaryXmlResourceParser.java:742-746Ôºâ
            if (in.remaining() < 8) {  // Ëá≥Â∞ëÈúÄË¶Å8Â≠óËäÇÔºàtype + sizeÔºâ
                LOGGER.warning(String.format("AXML hit unexpected end of file at position 0x%08x", in.position()));
                return END_FILE;
            }
            
            int type = in.getInt() & 0xFFFF;
            int size = in.getInt();
            
            // È™åËØÅchunkÂ§ßÂ∞è
            if (size < 8 || p + size > fileSize) {
                LOGGER.warning(String.format("Invalid chunk size %d at position 0x%08x", size, p));
                return END_FILE;
            }
            
            switch (type) {
            case RES_XML_START_ELEMENT_TYPE: {
                hasEncounteredStartElement = true;  // Ê†áËÆ∞Â∑≤ÈÅáÂà∞START_ELEMENT
                {
                    lineNumber = in.getInt();
                    in.getInt();/* skip, 0xFFFFFFFF */
                    nsIdx = in.getInt();
                    nameIdx = in.getInt();
                    int flag = in.getInt();// 0x00140014 ?
                    if (flag != 0x00140014) {
                        throw new RuntimeException();
                    }
                }

                attributeCount = in.getShort() & 0xFFFF;
                idAttribute = (in.getShort() & 0xFFFF) - 1;
                classAttribute = (in.getShort() & 0xFFFF) - 1;
                styleAttribute = (in.getShort() & 0xFFFF) - 1;

                attrs = in.asIntBuffer();

                event = START_TAG;
            }
                break;
            case RES_XML_END_ELEMENT_TYPE: {
                in.position(p + size);
                event = END_TAG;
            }
                break;
            case RES_XML_START_NAMESPACE_TYPE:
                lineNumber = in.getInt();
                in.getInt();/* 0xFFFFFFFF */
                prefixIdx = in.getInt();
                nsIdx = in.getInt();
                event = START_NS;
                break;
            case RES_XML_END_NAMESPACE_TYPE:
                // Èò≤Âæ°#3838: START_ELEMENTÂâçÁöÑÊó†ÊïàEND_NAMESPACEÔºàÂèÇËÄÉ Apktool:796-802Ôºâ
                if (!hasEncounteredStartElement) {
                    LOGGER.warning(String.format(
                        "Skipping END_NAMESPACE event at position 0x%08x before START_ELEMENT", p));
                    in.position(p + size);
                    continue;  // Ë∑≥ËøáÊ≠§‰∫ã‰ª∂ÔºåÁªßÁª≠Ëß£Êûê
                }
                in.position(p + size);
                event = END_NS;
                break;
            case RES_STRING_POOL_TYPE:
                // üîß ÂàõÂª∫StringItemsÂÆû‰æã‰ª•Êé•Êî∂flags
                StringItems stringItems = new StringItems();
                strings = StringItems.read(in, stringItems);
                stringPoolFlags = stringItems.getOriginalFlags();  // ‰øùÂ≠òflags
                in.position(p + size);
                continue;
            case RES_XML_RESOURCE_MAP_TYPE:
                int count = size / 4 - 2;
                if (count < 0 || count > 10000) {  // ÂêàÁêÜÊÄßÊ£ÄÊü•
                    LOGGER.warning("Invalid resource map count: " + count);
                    in.position(p + size);
                    continue;
                }
                resourceIds = new int[count];
                // Èò≤Âæ°#3236: Èò≤Ê≠¢ËØªÂèñË∂ÖÂá∫chunkËæπÁïåÔºàÂèÇËÄÉ Apktool:112-127Ôºâ
                int maxPosition = p + size;
                for (int i = 0; i < count; i++) {
                    if (in.position() + 4 > maxPosition) {
                        LOGGER.warning(String.format(
                            "Resource map entry %d at position 0x%08x exceeds chunk boundary at 0x%08x", 
                            i, in.position(), maxPosition));
                        break;  // ÊèêÂâçÁªàÊ≠¢ÔºåÈÅøÂÖçÂ¥©Ê∫É
                    }
                    resourceIds[i] = in.getInt();
                }
                in.position(p + size);
                continue;
            case RES_XML_CDATA_TYPE:
                lineNumber = in.getInt();
                in.getInt();/* 0xFFFFFFFF */
                textIdx = in.getInt();

                in.getInt();/* 00000008 00000000 */
                in.getInt();

                event = TEXT;
                break;
            default:
                // ÈÅáÂà∞Êú™Áü•chunkÁ±ªÂûãÊó∂‰ºòÈõÖÂ§ÑÁêÜÔºåËÄå‰∏çÊòØÂ¥©Ê∫É
                LOGGER.warning(String.format(
                    "Unknown chunk type 0x%04x at position 0x%08x, size=%d. Skipping.", 
                    type, p, size));
                in.position(p + size);
                continue;
            }
            in.position(p + size);
            return event;
        }
        return END_FILE;
    }
    
    /**
     * Ëé∑ÂèñStringPoolÁöÑÂéüÂßãflags
     * @return flagsÂÄºÔºà0x100Ë°®Á§∫UTF-8Ôºå0Ë°®Á§∫UTF-16Ôºâ
     */
    public int getStringPoolFlags() {
        return stringPoolFlags;
    }
}
